<html>
<head>
  <title>CornChat - Validate Token</title>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.3.7.min.js"></script>
	<h1>Validate CornChat API Token</h1>
  <div id="info">
  </div>
  <table>
    <tr>
      <td>API Token</td>
      <td><input type="api-token" id="api-token" size="20">
    </tr>
    <tr>
      <td colspan="2">
        <button type="submit" id="login-button">Login</button>
      </td>
    </tr>
  </table>
  <div>
    <button id="test-send-button">Test Send</button>
  </div>
  <script>
  var info = document.getElementById('info');
  var apiToken = document.getElementById('api-token');
  var loginButton = document.getElementById('login-button');
  var testSendButton = document.getElementById('test-send-button');
  AWS.config.update({
    region: '<REGION>',
    credentials: new AWS.CognitoIdentityCredentials({
      IdentityPoolId: '<IDENTITY_POOL_ID>'
    })
  });

  testSendButton.addEventListener('click', function() {
    info.innerHTML = "Testing...";
    var ddb = new AWS.DynamoDB();
    function storeTag(mid, tag, fn) {
      function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }
      var id = uuidv4();
  		ddb.putItem({
  			TableName: "CornchatTags",
  			Item: {
  				id: {
  					S: id
  				},
  				mid: {
  					S: mid
  				},
  				tag: {
  					S: tag
  				}
  			}
  		}, function(err, data) {
  			if (err) return fn(err);
  			else fn(null, id);
  		});
    }
    storeTag("blardeeblar", "blue", function(err, data) {
      if (err) console.log(err, err.stack);
      else {
        info.innerHTML = 'Stored ' + data + "<br/>";
      }
    });

  });
  loginButton.addEventListener('click', function() {
    info.innerHTML = 'Validating...';
    if (apiToken.value == null || apiToken.value == '') {
      info.innerHTML = 'Please specify an API token.';
    } else {
      var input = {
        apiToken: apiToken.value
      };
      var lambda = new AWS.Lambda();
      lambda.invoke({
        FunctionName: 'LambdAuthApiTokenLogin',
        Payload: JSON.stringify(input)
      }, function(err, data) {
        if (err) console.log(err, err.stack);
        else {
          var output = JSON.parse(data.Payload);
          if (!output.login) {
            info.innerHTML = '<b>Not</b> valid.';
          } else {
            info.innerHTML = 'Validated and Logged in with IdentityId: ' + output.identityId + '<br>';
            var creds = AWS.config.credentials;
      	    creds.params.IdentityId = output.identityId;
      	    creds.params.Logins = {
      	      'cognito-identity.amazonaws.com': output.token
      	    };
      	    creds.expired = true;
      	    // Do something with the authenticated role
          }
        }
      });
		}
  });
  </script>
</body>
</html>
